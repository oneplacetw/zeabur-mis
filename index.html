<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¶æ¬¾è³‡æ–™æŸ¥è©¢ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #788A79;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen" style="background-color: #E8EAEB;">
  <div id="app" class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å¸³å‹™æŸ¥è©¢</h1>
      </div>

      <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
      <div id="stepIndicator" class="flex items-center justify-center mb-8">
        <div class="flex items-center" style="color: #788A79;">
          <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-medium" style="background-color: #788A79;">1</div>
          <span class="ml-2 text-sm font-medium">æŸ¥è©¢</span>
        </div>
        <div id="stepLine" class="w-16 h-1 mx-2 bg-gray-300"></div>
        <div class="flex items-center text-gray-400">
          <div id="step2Circle" class="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 font-medium">2</div>
          <span class="ml-2 text-sm font-medium">å›å¡«</span>
        </div>
      </div>

      <!-- è¨Šæ¯å€ -->
      <div id="messageBox" class="mb-6 hidden"></div>

      <!-- æ­¥é©Ÿ 1: æŸ¥è©¢è¡¨å–® -->
      <div id="step1" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">è«‹è¼¸å…¥æ¬²æŸ¥è©¢ä¹‹æœ«5ç¢¼(æ•¸å­—) </label>
          <input
            type="text"
            id="searchNumber"
            placeholder="è«‹è¼¸å…¥5ä½æ•¸å­—"
            maxlength="5"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
            style="--tw-ring-color: #788A79;"
          />
          <p class="text-xs text-gray-500 mt-1">æ³¨æ„ä¸è¦è®ŠæˆåŠå½¢æ–‡å­—</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯æ¬¾æ—¥æœŸ</label>
          <input
            type="date"
            id="searchDate"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
            style="--tw-ring-color: #788A79;"
          />
        </div>

        <button
          id="searchBtn"
          class="w-full text-white py-3 rounded-lg font-medium transition-colors"
          style="background-color: #788A79;"
        >
          ğŸ” é–‹å§‹æŸ¥è©¢
        </button>
      </div>

      <!-- æ­¥é©Ÿ 2: å¡«å¯«è¡¨å–® (åˆå§‹éš±è—) -->
      <div id="step2" class="space-y-6 hidden">
        <div id="foundDataBox" class="p-4 rounded-lg mb-6" style="background-color: #E8EAEB;">
          <p class="text-sm font-medium mb-2" style="color: #788A79;">
            âœ“ å·²æ‰¾åˆ°åŒ¹é…è³‡æ–™
            <span id="matchCount" class="ml-2 px-2 py-1 text-white text-xs rounded-full" style="background-color: #788A79;"></span>
          </p>
          <div id="foundDataDetails" class="text-xs space-y-1 mt-3 border-t pt-3" style="color: #788A79; border-color: #788A79;"></div>
        </div>

        <!-- âœ… Switch åˆ‡æ›ï¼ˆåƒ…åœ¨å¤šç­†è³‡æ–™æ™‚é¡¯ç¤ºï¼‰ -->
        <div id="switchContainer" class="hidden mb-4">
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <p class="text-sm font-medium text-gray-700">è«‹å•æ˜¯å¦ä¸Šè¿°è³‡æ–™çš†ç‚ºä¸åŒäºº</p>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="samePersonSwitch" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#788A79]" style="--tw-ring-color: #788A79;"></div>
            </label>
          </div>
        </div>

        <!-- âœ… å–®ä¸€è¼¸å…¥æ¨¡å¼ï¼ˆdefaultï¼Œswitch æœªé–‹å•Ÿæ™‚ï¼‰ -->
        <div id="singleInputMode" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">å¡«å¯«ï¼ªï¼§ï¼¢id</label>
            <input
              type="text"
              id="inputNumber"
              placeholder="è«‹è¼¸å…¥æ•¸å­—"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
            style="--tw-ring-color: #788A79;"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ç§Ÿå®¢å§“å</label>
  <input
  type="text"
  id="inputText"
  placeholder="è«‹è¼¸å…¥ä¸»ç°½ç´„äººå…¨å"
  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
  style="--tw-ring-color: #788A79;"
/>
          </div>
        </div>

        <!-- âœ… å¤šç­†è¼¸å…¥æ¨¡å¼ï¼ˆswitch é–‹å•Ÿæ™‚ï¼‰ -->
        <div id="multipleInputMode" class="space-y-6 hidden">
          <div id="multipleInputsContainer"></div>
        </div>

        <div class="flex gap-3">
          <button
            id="resetBtn"
            class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition-colors"
          >
            é‡æ–°æŸ¥è©¢
          </button>
          <button
            id="submitBtn"
            class="flex-1 text-white py-3 rounded-lg font-medium transition-colors"
            style="background-color: #788A79;"
          >
            ğŸ“¤ é€å‡ºè³‡æ–™
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // âœ… å·²æ›´æ–°ç‚ºæœ€æ–°çš„éƒ¨ç½² URLï¼ˆå€‹äººå¸³è™Ÿï¼‰
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUB_pmqTCygYcNMZpTdM6BfOry5XlKrbmUQdzluKrQB_3xDfgZk__eCtv3ujz67w/exec';
    
    let foundData = null;

    // å–å¾—å…ƒç´ 
    const searchNumberInput = document.getElementById('searchNumber');
    const searchDateInput = document.getElementById('searchDate');
    const searchBtn = document.getElementById('searchBtn');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const messageBox = document.getElementById('messageBox');
    const inputNumber = document.getElementById('inputNumber');
    const inputText = document.getElementById('inputText');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const foundDataDetails = document.getElementById('foundDataDetails');
    const stepLine = document.getElementById('stepLine');
    const step2Circle = document.getElementById('step2Circle');
    const switchContainer = document.getElementById('switchContainer');
    const samePersonSwitch = document.getElementById('samePersonSwitch');
    const singleInputMode = document.getElementById('singleInputMode');
    const multipleInputMode = document.getElementById('multipleInputMode');
    const multipleInputsContainer = document.getElementById('multipleInputsContainer');

    // é™åˆ¶åªèƒ½è¼¸å…¥æ•¸å­—,æœ€å¤š5ä½
    searchNumberInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);
    });

    // âœ… é™åˆ¶ JGBid åªèƒ½è¼¸å…¥æ•¸å­—
    inputNumber.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    // âœ… Switch åˆ‡æ›äº‹ä»¶
    samePersonSwitch.addEventListener('change', (e) => {
      const isSamePerson = e.target.checked;
      if (isSamePerson) {
        // Switch é–‹å•Ÿï¼šé¡¯ç¤ºå¤šç­†è¼¸å…¥æ¨¡å¼
        singleInputMode.classList.add('hidden');
        multipleInputMode.classList.remove('hidden');
        generateMultipleInputs();
      } else {
        // Switch é—œé–‰ï¼šé¡¯ç¤ºå–®ä¸€è¼¸å…¥æ¨¡å¼
        singleInputMode.classList.remove('hidden');
        multipleInputMode.classList.add('hidden');
      }
    });

    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(type, text) {
      messageBox.className = `mb-6 p-4 rounded-lg flex items-center ${
        type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'
      }`;
      messageBox.innerHTML = `
        <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${
            type === 'success' 
              ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' 
              : 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
          }" />
        </svg>
        <span class="text-sm">${text}</span>
      `;
      messageBox.classList.remove('hidden');
    }

    function hideMessage() {
      messageBox.classList.add('hidden');
    }

    // åˆ‡æ›åˆ°æ­¥é©Ÿ2
    function goToStep2() {
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
      stepLine.classList.remove('bg-gray-300');
      stepLine.style.backgroundColor = '#788A79';
      step2Circle.classList.remove('bg-gray-300');
      step2Circle.style.backgroundColor = '#788A79';
      step2Circle.style.color = 'white';
      step2Circle.parentElement.classList.remove('text-gray-400');
      step2Circle.parentElement.style.color = '#788A79';
    }

    // âœ… ç”Ÿæˆå¤šç­†è¼¸å…¥æ¬„ä½
    function generateMultipleInputs() {
      const matches = foundData.matches || [{ row: foundData.row, data: foundData.data }];
      let html = '';
      
      matches.forEach((match, index) => {
        html += `
          <div class="border border-gray-200 rounded-lg p-4 bg-white">
            <p class="font-semibold text-gray-800 mb-3">ç¬¬ ${index + 1} ç­†</p>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">JGBid</label>
                <input
                  type="text"
                  class="multiple-jgbid w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
                  style="--tw-ring-color: #788A79;"
                  data-row="${match.row}"
                  placeholder="è«‹è¼¸å…¥æ•¸å­—"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç§Ÿå®¢å§“å</label>
                <input
                  type="text"
                  class="multiple-tenant w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent"
                  style="--tw-ring-color: #788A79;"
                  data-row="${match.row}"
                  placeholder="è«‹è¼¸å…¥æ–‡å­—"
                />
              </div>
            </div>
          </div>
        `;
      });
      
      multipleInputsContainer.innerHTML = html;
      
      // âœ… ç‚ºå¤šç­†è¼¸å…¥æ¬„ä½åŠ å…¥æ•¸å­—é™åˆ¶
      multipleInputsContainer.querySelectorAll('.multiple-jgbid').forEach(input => {
        input.addEventListener('input', (e) => {
          e.target.value = e.target.value.replace(/\D/g, '');
        });
      });
    }

    // é‡ç½®è¡¨å–®
    function resetForm() {
      step1.classList.remove('hidden');
      step2.classList.add('hidden');
      searchNumberInput.value = '';
      searchDateInput.value = '';
      inputNumber.value = '';
      inputText.value = '';
      foundData = null;
      hideMessage();
      
      // âœ… é‡ç½®åŒ¹é…ç­†æ•¸é¡¯ç¤ºå’Œ switch
      const matchCount = document.getElementById('matchCount');
      if (matchCount) {
        matchCount.textContent = '';
      }
      foundDataDetails.innerHTML = '';
      switchContainer.classList.add('hidden');
      samePersonSwitch.checked = false;
      singleInputMode.classList.remove('hidden');
      multipleInputMode.classList.add('hidden');
      multipleInputsContainer.innerHTML = '';
      
      stepLine.classList.add('bg-gray-300');
      stepLine.style.backgroundColor = '';
      step2Circle.classList.add('bg-gray-300');
      step2Circle.style.backgroundColor = '';
      step2Circle.style.color = '';
      step2Circle.parentElement.classList.add('text-gray-400');
      step2Circle.parentElement.style.color = '';
    }

    // âœ… ä¿®æ­£ï¼šè™•ç† Apps Script Web App çš„ç‰¹æ®Š fetch éœ€æ±‚
    // Apps Script Web App æœƒåš 302 redirectï¼Œéœ€è¦æ­£ç¢ºè™•ç†
    async function callAppsScript(action, payload) {
      try {
        // æ–¹æ³• 1: ä½¿ç”¨ JSONï¼ˆå„ªå…ˆå˜—è©¦ï¼‰
        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            redirect: 'follow',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: action,
              ...payload
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          console.log('ğŸ“¦ åŸå§‹å›æ‡‰:', text);
          
          // å˜—è©¦è§£æ JSON
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            // å¦‚æœå›æ‡‰ä¸æ˜¯ JSONï¼Œå¯èƒ½æ˜¯ HTML éŒ¯èª¤é 
            throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤: ' + text.substring(0, 100));
          }

          return data;
        } catch (jsonError) {
          console.warn('JSON æ–¹å¼å¤±æ•—ï¼Œæ”¹ç”¨è¡¨å–®æ–¹å¼:', jsonError);
          
          // æ–¹æ³• 2: æ”¹ç”¨è¡¨å–®æ–¹å¼æäº¤ï¼ˆApps Script æ›´ç›¸å®¹ï¼‰
          const formData = new FormData();
          formData.append('action', action);
          Object.keys(payload).forEach(key => {
            formData.append(key, payload[key]);
          });

          const formResponse = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            redirect: 'follow',
            body: formData
          });

          if (!formResponse.ok) {
            throw new Error(`HTTP error! status: ${formResponse.status}`);
          }

          const text = await formResponse.text();
          console.log('ğŸ“¦ è¡¨å–®å›æ‡‰:', text);
          
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤: ' + text.substring(0, 100));
          }

          return data;
        }
      } catch (error) {
        console.error('âŒ API å‘¼å«éŒ¯èª¤:', error);
        throw error;
      }
    }

    // æŸ¥è©¢åŠŸèƒ½
    searchBtn.addEventListener('click', async () => {
      const number = searchNumberInput.value;
      const date = searchDateInput.value;

      if (!number || !date) {
        showMessage('error', 'è«‹è¼¸å…¥æœ«5ç¢¼æ•¸å­—å’Œæ—¥æœŸ');
        return;
      }

      if (number.length !== 5) {
        showMessage('error', 'è«‹è¼¸å…¥å®Œæ•´çš„5ä½æ•¸å­—');
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      searchBtn.disabled = true;
      searchBtn.innerHTML = '<div class="spinner"></div>æŸ¥è©¢ä¸­...';
      hideMessage();

      console.log('ğŸ” é–‹å§‹æŸ¥è©¢:', { number, date });
      console.log('ğŸ“¡ API URL:', SCRIPT_URL);

      try {
        // âœ… æ”¹ç”¨ä¿®æ­£å¾Œçš„å‘¼å«æ–¹å¼
        const data = await callAppsScript('search', {
          number: number,
          date: date
        });

        console.log('ğŸ“¦ å›æ‡‰è³‡æ–™:', data);
        console.log('ğŸ“¦ å›æ‡‰æ ¼å¼æª¢æŸ¥:', {
          hasCount: 'count' in data,
          hasMatches: 'matches' in data,
          hasRow: 'row' in data,
          hasData: 'data' in data
        });

        if (data.found) {
          foundData = data;
          
          // âœ… é¡¯ç¤ºç­†æ•¸
          const matchCount = document.getElementById('matchCount');
          if (matchCount) {
            // å„ªå…ˆä½¿ç”¨æ–°æ ¼å¼çš„ countï¼Œå¦å‰‡ä½¿ç”¨ matches é™£åˆ—é•·åº¦ï¼Œæœ€å¾Œæ‰ç”¨èˆŠæ ¼å¼çš„å–®ç­†
            const count = data.count || (data.matches ? data.matches.length : 1);
            matchCount.textContent = `å…± ${count} ç­†`;
            console.log('ğŸ“Š é¡¯ç¤ºç­†æ•¸:', count);
          }
          
          // âœ… é¡¯ç¤ºæ‰€æœ‰åŒ¹é…çš„è³‡æ–™ï¼ˆç°¡åŒ–ç‰ˆï¼šåªé¡¯ç¤ºé‡‘é¡å’Œä»˜æ¬¾éŠ€è¡Œï¼‰
          // å„ªå…ˆä½¿ç”¨æ–°æ ¼å¼çš„ matchesï¼Œå¦å‰‡è½‰æ›èˆŠæ ¼å¼ç‚ºé™£åˆ—
          const matches = data.matches || (data.row ? [{ row: data.row, data: data.data }] : []);
          console.log('ğŸ“‹ åŒ¹é…è³‡æ–™é™£åˆ—:', matches);
          console.log('ğŸ“‹ åŒ¹é…è³‡æ–™æ•¸é‡:', matches.length);
          let detailsHTML = '';
          
          matches.forEach((match, index) => {
            detailsHTML += `
              <div class="mb-3 pb-3 ${index < matches.length - 1 ? 'border-b' : ''}" style="border-color: #788A79;">
                <p class="font-semibold mb-1" style="color: #788A79;">ç¬¬ ${index + 1} ç­†</p>
                <p><strong>é‡‘é¡:</strong> ${match.data.amount || 'ç„¡'}</p>
                <p><strong>ä»˜æ¬¾éŠ€è¡Œ:</strong> ${match.data.bank || 'ç„¡'}</p>
              </div>
            `;
          });
          
          foundDataDetails.innerHTML = detailsHTML;
          
          const totalCount = data.count || matches.length;
          showMessage('success', `æ‰¾åˆ° ${totalCount} ç­†åŒ¹é…è³‡æ–™!`);
          
          // âœ… å¦‚æœæœ‰å¤šç­†è³‡æ–™ï¼Œé¡¯ç¤º switch
          if (totalCount > 1) {
            switchContainer.classList.remove('hidden');
          } else {
            switchContainer.classList.add('hidden');
            samePersonSwitch.checked = false;
          }
          
          goToStep2();
        } else {
          showMessage('error', data.message || 'æœªæ‰¾åˆ°åŒ¹é…çš„è³‡æ–™');
        }
      } catch (error) {
        console.error('âŒ æŸ¥è©¢éŒ¯èª¤:', error);
        showMessage('error', 'æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = 'ğŸ” é–‹å§‹æŸ¥è©¢';
      }
    });

    // æäº¤åŠŸèƒ½
    submitBtn.addEventListener('click', async () => {
      // âœ… æª¢æŸ¥æ˜¯å¦ç‚ºå¤šç­†è¼¸å…¥æ¨¡å¼
      const isMultipleMode = !multipleInputMode.classList.contains('hidden');
      const matches = foundData.matches || [{ row: foundData.row }];
      
      let updateData = [];
      
      if (isMultipleMode) {
        // å¤šç­†è¼¸å…¥æ¨¡å¼ï¼šæ¯ç­†è³‡æ–™éƒ½æœ‰ç¨ç«‹çš„æ¬„ä½
        const jgbidInputs = multipleInputsContainer.querySelectorAll('.multiple-jgbid');
        const tenantInputs = multipleInputsContainer.querySelectorAll('.multiple-tenant');
        
        // é©—è­‰æ‰€æœ‰æ¬„ä½éƒ½å·²å¡«å¯«
        let allFilled = true;
        jgbidInputs.forEach((input, index) => {
          const jgbid = input.value.trim();
          const tenant = tenantInputs[index].value.trim();
          
          // âœ… é©—è­‰ JGBid æ˜¯å¦ç‚ºæ•¸å­—
          if (!jgbid || !/^\d+$/.test(jgbid)) {
            allFilled = false;
            showMessage('error', `ç¬¬ ${index + 1} ç­†çš„ JGBid å¿…é ˆç‚ºæ•¸å­—æ ¼å¼`);
            return;
          }
          
          if (!tenant) {
            allFilled = false;
            showMessage('error', `ç¬¬ ${index + 1} ç­†çš„ç§Ÿå®¢å§“åæœªå¡«å¯«`);
            return;
          }
          
          updateData.push({
            row: parseInt(input.dataset.row),
            columnG: jgbid,
            columnH: tenant
          });
        });
        
        if (!allFilled) {
          return;
        }
      } else {
        // å–®ä¸€è¼¸å…¥æ¨¡å¼ï¼šæ‰€æœ‰è³‡æ–™å…±ç”¨åŒä¸€çµ„è¼¸å…¥
        const numValue = inputNumber.value.trim();
        const textValue = inputText.value.trim();

        if (!numValue || !textValue) {
          showMessage('error', 'è«‹å®Œæ•´å¡«å¯«æ•¸å­—å’Œæ–‡å­—');
          return;
        }

        // âœ… é©—è­‰ numValue æ˜¯å¦ç‚ºæ•¸å­—æ ¼å¼
        if (!/^\d+$/.test(numValue)) {
          showMessage('error', 'JGBid å¿…é ˆç‚ºæ•¸å­—æ ¼å¼');
          return;
        }

        // æ‰€æœ‰åŒ¹é…çš„ row éƒ½ä½¿ç”¨ç›¸åŒçš„å€¼
        matches.forEach(match => {
          updateData.push({
            row: match.row,
            columnG: numValue,
            columnH: textValue
          });
        });
      }

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner"></div>é€å‡ºä¸­...';
      hideMessage();

      const totalRows = updateData.length;
      
      console.log('ğŸ“¤ é–‹å§‹æäº¤:', { 
        totalRows: totalRows, 
        updateData: updateData,
        isMultipleMode: isMultipleMode
      });

      try {
        // âœ… å°æ‰€æœ‰éœ€è¦æ›´æ–°çš„ row åŸ·è¡Œæ›´æ–°
        const updatePromises = updateData.map(async (data, index) => {
          console.log(`ğŸ“ æ›´æ–°ç¬¬ ${index + 1}/${totalRows} ç­†: ç¬¬ ${data.row} è¡Œ`);
          return await callAppsScript('update', {
            row: data.row,
            columnG: data.columnG,
            columnH: data.columnH
          });
        });

        // ç­‰å¾…æ‰€æœ‰æ›´æ–°å®Œæˆ
        const results = await Promise.all(updatePromises);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å¤±æ•—çš„æ›´æ–°
        const failedUpdates = results.filter(r => !r.success);
        const successCount = results.length - failedUpdates.length;

        console.log('ğŸ“¦ æ›´æ–°çµæœ:', { 
          total: results.length, 
          success: successCount, 
          failed: failedUpdates.length 
        });

        if (failedUpdates.length === 0) {
          showMessage('success', `å·²æˆåŠŸå›å¯« ${successCount} ç­†è³‡æ–™`);
          setTimeout(() => resetForm(), 3000);
        } else {
          const errorMessages = failedUpdates.map(r => r.error || 'æœªçŸ¥éŒ¯èª¤').join(', ');
          showMessage('error', `${successCount} ç­†æˆåŠŸï¼Œ${failedUpdates.length} ç­†å¤±æ•—: ${errorMessages}`);
        }
      } catch (error) {
        console.error('âŒ æäº¤éŒ¯èª¤:', error);
        showMessage('error', 'æäº¤æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ğŸ“¤ é€å‡ºè³‡æ–™';
      }
    });

    // é‡æ–°æŸ¥è©¢æŒ‰éˆ•
    resetBtn.addEventListener('click', resetForm);

    // é é¢è¼‰å…¥å®Œæˆ
    console.log('âœ… é é¢å·²è¼‰å…¥å®Œæˆ');
    console.log('ğŸ“¡ API URL:', SCRIPT_URL);
  </script>
</body>
</html>
