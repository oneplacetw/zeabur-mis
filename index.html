<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¶æ¬¾è³‡æ–™æŸ¥è©¢ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4F46E5;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="app" class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å¸³å‹™æŸ¥è©¢</h1>
      </div>

      <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
      <div id="stepIndicator" class="flex items-center justify-center mb-8">
        <div class="flex items-center text-indigo-600">
          <div class="w-8 h-8 rounded-full flex items-center justify-center bg-indigo-600 text-white font-medium">1</div>
          <span class="ml-2 text-sm font-medium">æŸ¥è©¢</span>
        </div>
        <div id="stepLine" class="w-16 h-1 mx-2 bg-gray-300"></div>
        <div class="flex items-center text-gray-400">
          <div id="step2Circle" class="w-8 h-8 rounded-full flex items-center justify-center bg-gray-300 font-medium">2</div>
          <span class="ml-2 text-sm font-medium">å›å¡«</span>
        </div>
      </div>

      <!-- è¨Šæ¯å€ -->
      <div id="messageBox" class="mb-6 hidden"></div>

      <!-- æ­¥é©Ÿ 1: æŸ¥è©¢è¡¨å–® -->
      <div id="step1" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">è«‹è¼¸å…¥æ¬²æŸ¥è©¢ä¹‹æœ«5ç¢¼(æ•¸å­—) </label>
          <input
            type="text"
            id="searchNumber"
            placeholder="è«‹è¼¸å…¥5ä½æ•¸å­—"
            maxlength="5"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />
          <p class="text-xs text-gray-500 mt-1">æ³¨æ„ä¸è¦è®ŠæˆåŠå½¢æ–‡å­—</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">åŒ¯æ¬¾æ—¥æœŸ</label>
          <input
            type="date"
            id="searchDate"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />
        </div>

        <button
          id="searchBtn"
          class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors"
        >
          ğŸ” é–‹å§‹æŸ¥è©¢
        </button>
      </div>

      <!-- æ­¥é©Ÿ 2: å¡«å¯«è¡¨å–® (åˆå§‹éš±è—) -->
      <div id="step2" class="space-y-6 hidden">
        <div id="foundDataBox" class="bg-indigo-50 p-4 rounded-lg mb-6">
          <p class="text-sm text-indigo-800 font-medium mb-2">
            âœ“ å·²æ‰¾åˆ°åŒ¹é…è³‡æ–™
            <span id="matchCount" class="ml-2 px-2 py-1 bg-indigo-600 text-white text-xs rounded-full"></span>
          </p>
          <div id="foundDataDetails" class="text-xs text-indigo-700 space-y-1 mt-3 border-t border-indigo-200 pt-3"></div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">å¡«å¯«ï¼ªï¼§ï¼¢id</label>
          <input
            type="text"
            id="inputNumber"
            placeholder="è«‹è¼¸å…¥æ•¸å­—"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ç§Ÿå®¢å§“å</label>
          <textarea
            id="inputText"
            placeholder="è«‹è¼¸å…¥æ–‡å­—"
            rows="4"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
          ></textarea>
        </div>

        <div class="flex gap-3">
          <button
            id="resetBtn"
            class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300 transition-colors"
          >
            é‡æ–°æŸ¥è©¢
          </button>
          <button
            id="submitBtn"
            class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors"
          >
            ğŸ“¤ é€å‡ºè³‡æ–™
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // âœ… å·²æ›´æ–°ç‚ºæœ€æ–°çš„éƒ¨ç½² URLï¼ˆå€‹äººå¸³è™Ÿï¼‰
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxIecm6_DVlCX-HwvDceDYmuzuzc_bPw7GHRFBIvfcw0f7ya-xy_SKsHRlrexa3Vg-zJg/exec';
    
    let foundData = null;

    // å–å¾—å…ƒç´ 
    const searchNumberInput = document.getElementById('searchNumber');
    const searchDateInput = document.getElementById('searchDate');
    const searchBtn = document.getElementById('searchBtn');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const messageBox = document.getElementById('messageBox');
    const inputNumber = document.getElementById('inputNumber');
    const inputText = document.getElementById('inputText');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const foundDataDetails = document.getElementById('foundDataDetails');
    const stepLine = document.getElementById('stepLine');
    const step2Circle = document.getElementById('step2Circle');

    // é™åˆ¶åªèƒ½è¼¸å…¥æ•¸å­—,æœ€å¤š5ä½
    searchNumberInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);
    });

    // é¡¯ç¤ºè¨Šæ¯
    function showMessage(type, text) {
      messageBox.className = `mb-6 p-4 rounded-lg flex items-center ${
        type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'
      }`;
      messageBox.innerHTML = `
        <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${
            type === 'success' 
              ? 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' 
              : 'M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
          }" />
        </svg>
        <span class="text-sm">${text}</span>
      `;
      messageBox.classList.remove('hidden');
    }

    function hideMessage() {
      messageBox.classList.add('hidden');
    }

    // åˆ‡æ›åˆ°æ­¥é©Ÿ2
    function goToStep2() {
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
      stepLine.classList.remove('bg-gray-300');
      stepLine.classList.add('bg-indigo-600');
      step2Circle.classList.remove('bg-gray-300');
      step2Circle.classList.add('bg-indigo-600', 'text-white');
      step2Circle.parentElement.classList.remove('text-gray-400');
      step2Circle.parentElement.classList.add('text-indigo-600');
    }

    // é‡ç½®è¡¨å–®
    function resetForm() {
      step1.classList.remove('hidden');
      step2.classList.add('hidden');
      searchNumberInput.value = '';
      searchDateInput.value = '';
      inputNumber.value = '';
      inputText.value = '';
      foundData = null;
      hideMessage();
      
      // âœ… é‡ç½®åŒ¹é…ç­†æ•¸é¡¯ç¤º
      const matchCount = document.getElementById('matchCount');
      if (matchCount) {
        matchCount.textContent = '';
      }
      foundDataDetails.innerHTML = '';
      
      stepLine.classList.add('bg-gray-300');
      stepLine.classList.remove('bg-indigo-600');
      step2Circle.classList.add('bg-gray-300');
      step2Circle.classList.remove('bg-indigo-600', 'text-white');
      step2Circle.parentElement.classList.add('text-gray-400');
      step2Circle.parentElement.classList.remove('text-indigo-600');
    }

    // âœ… ä¿®æ­£ï¼šè™•ç† Apps Script Web App çš„ç‰¹æ®Š fetch éœ€æ±‚
    // Apps Script Web App æœƒåš 302 redirectï¼Œéœ€è¦æ­£ç¢ºè™•ç†
    async function callAppsScript(action, payload) {
      try {
        // æ–¹æ³• 1: ä½¿ç”¨ JSONï¼ˆå„ªå…ˆå˜—è©¦ï¼‰
        try {
          const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            redirect: 'follow',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              action: action,
              ...payload
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const text = await response.text();
          console.log('ğŸ“¦ åŸå§‹å›æ‡‰:', text);
          
          // å˜—è©¦è§£æ JSON
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            // å¦‚æœå›æ‡‰ä¸æ˜¯ JSONï¼Œå¯èƒ½æ˜¯ HTML éŒ¯èª¤é 
            throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤: ' + text.substring(0, 100));
          }

          return data;
        } catch (jsonError) {
          console.warn('JSON æ–¹å¼å¤±æ•—ï¼Œæ”¹ç”¨è¡¨å–®æ–¹å¼:', jsonError);
          
          // æ–¹æ³• 2: æ”¹ç”¨è¡¨å–®æ–¹å¼æäº¤ï¼ˆApps Script æ›´ç›¸å®¹ï¼‰
          const formData = new FormData();
          formData.append('action', action);
          Object.keys(payload).forEach(key => {
            formData.append(key, payload[key]);
          });

          const formResponse = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            redirect: 'follow',
            body: formData
          });

          if (!formResponse.ok) {
            throw new Error(`HTTP error! status: ${formResponse.status}`);
          }

          const text = await formResponse.text();
          console.log('ğŸ“¦ è¡¨å–®å›æ‡‰:', text);
          
          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤: ' + text.substring(0, 100));
          }

          return data;
        }
      } catch (error) {
        console.error('âŒ API å‘¼å«éŒ¯èª¤:', error);
        throw error;
      }
    }

    // æŸ¥è©¢åŠŸèƒ½
    searchBtn.addEventListener('click', async () => {
      const number = searchNumberInput.value;
      const date = searchDateInput.value;

      if (!number || !date) {
        showMessage('error', 'è«‹è¼¸å…¥æœ«5ç¢¼æ•¸å­—å’Œæ—¥æœŸ');
        return;
      }

      if (number.length !== 5) {
        showMessage('error', 'è«‹è¼¸å…¥å®Œæ•´çš„5ä½æ•¸å­—');
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      searchBtn.disabled = true;
      searchBtn.innerHTML = '<div class="spinner"></div>æŸ¥è©¢ä¸­...';
      hideMessage();

      console.log('ğŸ” é–‹å§‹æŸ¥è©¢:', { number, date });
      console.log('ğŸ“¡ API URL:', SCRIPT_URL);

      try {
        // âœ… æ”¹ç”¨ä¿®æ­£å¾Œçš„å‘¼å«æ–¹å¼
        const data = await callAppsScript('search', {
          number: number,
          date: date
        });

        console.log('ğŸ“¦ å›æ‡‰è³‡æ–™:', data);

        if (data.found) {
          foundData = data;
          
          // âœ… é¡¯ç¤ºç­†æ•¸
          const matchCount = document.getElementById('matchCount');
          if (matchCount) {
            matchCount.textContent = `å…± ${data.count || data.matches?.length || 1} ç­†`;
          }
          
          // âœ… é¡¯ç¤ºæ‰€æœ‰åŒ¹é…çš„è³‡æ–™ï¼ˆç°¡åŒ–ç‰ˆï¼šåªé¡¯ç¤ºé‡‘é¡å’Œä»˜æ¬¾éŠ€è¡Œï¼‰
          const matches = data.matches || [{ row: data.row, data: data.data }];
          let detailsHTML = '';
          
          matches.forEach((match, index) => {
            detailsHTML += `
              <div class="mb-3 pb-3 ${index < matches.length - 1 ? 'border-b border-indigo-200' : ''}">
                <p class="font-semibold text-indigo-900 mb-1">ç¬¬ ${index + 1} ç­† - ç¬¬ ${match.row} è¡Œ</p>
                <p><strong>é‡‘é¡:</strong> ${match.data.amount || 'ç„¡'}</p>
                <p><strong>ä»˜æ¬¾éŠ€è¡Œ:</strong> ${match.data.bank || 'ç„¡'}</p>
              </div>
            `;
          });
          
          foundDataDetails.innerHTML = detailsHTML;
          
          const totalCount = data.count || matches.length;
          showMessage('success', `æ‰¾åˆ° ${totalCount} ç­†åŒ¹é…è³‡æ–™!`);
          goToStep2();
        } else {
          showMessage('error', data.message || 'æœªæ‰¾åˆ°åŒ¹é…çš„è³‡æ–™');
        }
      } catch (error) {
        console.error('âŒ æŸ¥è©¢éŒ¯èª¤:', error);
        showMessage('error', 'æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      } finally {
        searchBtn.disabled = false;
        searchBtn.innerHTML = 'ğŸ” é–‹å§‹æŸ¥è©¢';
      }
    });

    // æäº¤åŠŸèƒ½
    submitBtn.addEventListener('click', async () => {
      const numValue = inputNumber.value;
      const textValue = inputText.value;

      if (!numValue || !textValue) {
        showMessage('error', 'è«‹å®Œæ•´å¡«å¯«æ•¸å­—å’Œæ–‡å­—');
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner"></div>é€å‡ºä¸­...';
      hideMessage();

      // âœ… å–å¾—æ‰€æœ‰éœ€è¦æ›´æ–°çš„ row
      const matches = foundData.matches || [{ row: foundData.row }];
      const totalRows = matches.length;
      
      console.log('ğŸ“¤ é–‹å§‹æäº¤:', { 
        totalRows: totalRows, 
        rows: matches.map(m => m.row),
        numValue, 
        textValue 
      });

      try {
        // âœ… å°æ‰€æœ‰åŒ¹é…çš„ row éƒ½åŸ·è¡Œæ›´æ–°
        const updatePromises = matches.map(async (match, index) => {
          console.log(`ğŸ“ æ›´æ–°ç¬¬ ${index + 1}/${totalRows} ç­†: ç¬¬ ${match.row} è¡Œ`);
          return await callAppsScript('update', {
            row: match.row,
            columnG: numValue,
            columnH: textValue
          });
        });

        // ç­‰å¾…æ‰€æœ‰æ›´æ–°å®Œæˆ
        const results = await Promise.all(updatePromises);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å¤±æ•—çš„æ›´æ–°
        const failedUpdates = results.filter(r => !r.success);
        const successCount = results.length - failedUpdates.length;

        console.log('ğŸ“¦ æ›´æ–°çµæœ:', { 
          total: results.length, 
          success: successCount, 
          failed: failedUpdates.length 
        });

        if (failedUpdates.length === 0) {
          showMessage('success', `è³‡æ–™å·²æˆåŠŸå›å¯«è‡³ ${successCount} ç­† Google Sheets è³‡æ–™!`);
          setTimeout(() => resetForm(), 3000);
        } else {
          const errorMessages = failedUpdates.map(r => r.error || 'æœªçŸ¥éŒ¯èª¤').join(', ');
          showMessage('error', `${successCount} ç­†æˆåŠŸï¼Œ${failedUpdates.length} ç­†å¤±æ•—: ${errorMessages}`);
        }
      } catch (error) {
        console.error('âŒ æäº¤éŒ¯èª¤:', error);
        showMessage('error', 'æäº¤æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ğŸ“¤ é€å‡ºè³‡æ–™';
      }
    });

    // é‡æ–°æŸ¥è©¢æŒ‰éˆ•
    resetBtn.addEventListener('click', resetForm);

    // é é¢è¼‰å…¥å®Œæˆ
    console.log('âœ… é é¢å·²è¼‰å…¥å®Œæˆ');
    console.log('ğŸ“¡ API URL:', SCRIPT_URL);
  </script>
</body>
</html>
